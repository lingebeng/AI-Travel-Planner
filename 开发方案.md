# AI Travel Planner 开发方案（4天冲刺版）

> ⚠️ **时间限制**: 4天完成核心功能，聚焦 MVP（最小可行产品）

## 一、项目概述

### 1.1 项目目标
开发一个基于 Web 的智能旅行规划应用，通过 AI 技术简化旅行规划流程，为用户提供个性化的旅行路线和预算管理功能。

### 1.2 核心价值（MVP 版本）
- **智能化**：利用大语言模型理解用户需求，自动生成旅行方案
- **便捷性**：支持语音输入，降低使用门槛
- **可视化**：地图展示行程路线
- **数据持久化**：基础的用户认证和数据存储

### 1.3 功能优先级（4天计划）
#### 🔴 P0 - 必须实现（核心功能）
- 语音/文字输入旅行需求
- AI 生成行程规划
- 地图展示行程路线
- 基础用户认证和数据存储
- Docker 部署配置

#### 🟡 P1 - 尽量实现
- 预算估算功能
- 行程编辑和保存
- 简单的费用记录

#### ⚪ P2 - 时间允许再做
- 语音记账
- 多设备同步
- 行程分享
- 详细的数据统计

## 二、技术架构设计

### 2.1 整体架构
```
┌─────────────────────────────────────────────┐
│           前端 (React + TypeScript)          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 地图界面 │  │ 行程展示 │  │ 语音输入 │  │
│  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────┬───────────────────────────┘
                  │ REST API
┌─────────────────▼───────────────────────────┐
│           后端 (Flask + Python)              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │ 语音服务 │  │ AI 规划  │  │ 地图服务 │  │
│  └──────────┘  └──────────┘  └──────────┘  │
└─────────┬───────────┬────────────┬──────────┘
          │           │            │
    ┌─────▼─────┐ ┌──▼──────┐ ┌──▼──────┐
    │ Supabase  │ │ DeepSeek│ │ 高德地图│
    │  数据库   │ │   API   │ │   API   │
    └───────────┘ └─────────┘ └─────────┘
```

### 2.2 技术栈确认（4天版）
- **后端**: Python 3.12 + Flask
- **前端**: React 18 + TypeScript + Ant Design + Vite
- **语音识别**: SpeechRecognition (Google Speech API) - 已有代码可复用
- **大语言模型**: DeepSeek API 或阿里云百炼平台
- **地图服务**: 高德地图 Web API
- **数据库**: Supabase (PostgreSQL + 认证服务)
- **部署**: Docker + Docker Compose
- **CI/CD**: 手动构建 Docker 镜像（GitHub Actions 可选）

### 2.3 目录结构设计（简化版）
```
AI-Travel-Planner/
├── backend/                    # 后端目录
│   ├── app/
│   │   ├── __init__.py        # Flask 应用初始化
│   │   ├── config.py          # 配置管理
│   │   ├── models.py          # 数据模型（单文件）
│   │   ├── services/          # 业务逻辑层
│   │   │   ├── voice_service.py       # 语音识别（复用 prepare/）
│   │   │   ├── ai_service.py          # AI 规划服务
│   │   │   └── map_service.py         # 地图服务
│   │   ├── routes.py          # API 路由（单文件）
│   │   └── utils.py           # 工具函数
│   ├── requirements.txt       # Python 依赖
│   ├── run.py                # 应用入口
│   └── Dockerfile            # 后端 Docker 配置
├── frontend/                  # 前端目录
│   ├── src/
│   │   ├── components/        # React 组件
│   │   │   ├── VoiceInput.tsx   # 语音输入
│   │   │   ├── ItineraryForm.tsx # 行程表单
│   │   │   ├── ItineraryView.tsx # 行程展示
│   │   │   └── MapView.tsx      # 地图组件
│   │   ├── services/         # API 调用
│   │   │   └── api.ts
│   │   ├── types.ts          # TypeScript 类型
│   │   └── App.tsx           # 主应用
│   ├── package.json
│   └── Dockerfile           # 前端 Docker 配置
├── docker-compose.yml        # Docker 编排
├── prepare/                  # 准备工作（已有）
├── docs/                     # 文档
├── .env.example             # 环境变量示例
└── README.md                # 项目说明
```

## 三、4天开发计划（超紧凑）

### 🚀 第1天：基础架构 + 后端核心服务

#### 上午（4小时）：项目初始化
- [x] ~~创建项目目录结构~~
- [ ] 注册并配置 Supabase 项目
  - [ ] 创建数据库表（users, itineraries）
  - [ ] 配置认证服务
  - [ ] 获取 API Keys
- [ ] 初始化后端 Flask 项目
  - [ ] 配置管理系统（支持 .env）
  - [ ] Supabase 客户端集成
  - [ ] 基础路由框架
- [ ] 初始化前端 Vite + React 项目
  - [ ] 安装 Ant Design
  - [ ] 配置 axios
  - [ ] Supabase 客户端初始化
  - [ ] 基础布局

#### 下午（4小时）：后端核心服务
- [ ] 语音识别服务
  - [ ] 迁移 `prepare/语音识别.py` 到 `voice_service.py`
  - [ ] 实现语音上传 API
  - [ ] 测试语音转文字
- [ ] AI 规划服务（重点）
  - [ ] DeepSeek API 集成
  - [ ] 提示词设计
  - [ ] 行程生成 API
  - [ ] 结构化输出（JSON）

#### 晚上（2-3小时）：地图服务准备
- [ ] 注册高德地图 API Key
- [ ] 实现基础地图服务（地点搜索、路线规划）
- [ ] API 测试

**第1天目标**: 后端核心 API 全部就绪，可用 Postman 测试

---

### 🎨 第2天：前端核心界面 + 功能集成

#### 上午（4小时）：前端核心组件
- [ ] 语音输入组件
  - [ ] 录音按钮和状态显示
  - [ ] 调用后端 API
  - [ ] 显示识别结果
- [ ] 行程输入表单
  - [ ] 目的地、日期、预算、人数、偏好
  - [ ] 表单验证
  - [ ] 提交到后端

#### 下午（4小时）：行程展示 + 地图集成
- [ ] 行程展示组件
  - [ ] 时间轴布局（Ant Design Timeline）
  - [ ] 每日行程卡片
  - [ ] 景点、交通、住宿详情
- [ ] 地图组件
  - [ ] 集成高德地图 JS API
  - [ ] 标记景点位置
  - [ ] 显示路线

#### 晚上（2-3小时）：前后端联调
- [ ] 完整流程测试
  - [ ] 语音输入 → AI 生成 → 地图展示
  - [ ] 文字输入 → AI 生成 → 地图展示
- [ ] Bug 修复
- [ ] UI 优化

**第2天目标**: 核心功能完整跑通

---

### 💾 第3天：用户系统 + 数据持久化 + 预算功能

#### 上午（4小时）：用户系统
- [ ] Supabase 用户认证集成
  - [ ] 后端认证中间件（验证 Supabase JWT）
  - [ ] 前端 Supabase Auth 集成
- [ ] 前端登录界面
  - [ ] 登录/注册表单（使用 Supabase Auth UI 或自定义）
  - [ ] 会话管理
  - [ ] 路由守卫

#### 下午（4小时）：数据持久化
- [ ] 行程保存功能
  - [ ] 数据库表设计
  - [ ] 保存/查询/更新/删除 API
  - [ ] 我的行程列表页面
- [ ] 预算功能（P1）
  - [ ] AI 预算估算（集成到行程生成）
  - [ ] 预算展示组件
  - [ ] 简单的费用记录（如果时间够）

#### 晚上（2-3小时）：功能完善
- [ ] UI/UX 优化
  - [ ] 加载状态
  - [ ] 错误提示
  - [ ] 空状态页面
- [ ] 响应式布局调整
- [ ] 细节打磨

**第3天目标**: 所有核心功能完成，可演示

---

### 🐳 第4天：Docker 部署 + 文档 + 测试

#### 上午（4小时）：Docker 配置
- [ ] 编写 Dockerfile（前端 + 后端）
- [ ] 编写 docker-compose.yml
- [ ] 本地 Docker 构建测试
- [ ] 环境变量配置
- [ ] 镜像优化（多阶段构建）

#### 下午（4小时）：文档 + 测试
- [ ] README.md 完善
  - [ ] 项目介绍
  - [ ] 功能说明
  - [ ] 技术栈
  - [ ] 本地开发指南
  - [ ] Docker 运行指南
  - [ ] API Key 配置说明
  - [ ] 功能演示截图
- [ ] 功能测试
  - [ ] 核心流程测试
  - [ ] 边界情况测试
  - [ ] 错误处理测试

#### 晚上（2-3小时）：最终准备
- [ ] Docker 镜像推送到阿里云
- [ ] GitHub 仓库整理
  - [ ] 检查是否有 API Key 泄露
  - [ ] commit 历史整理
  - [ ] 添加 LICENSE
- [ ] 提交 PDF 制作
  - [ ] GitHub 链接
  - [ ] Docker 镜像地址
  - [ ] 运行说明
  - [ ] 演示截图
- [ ] 最终检查

**第4天目标**: 完成所有交付材料，可以提交

---

## 四、数据库设计（Supabase）

### 4.1 核心表结构

#### users（用户表 - 由 Supabase Auth 自动管理）
Supabase 提供的 `auth.users` 表已包含基本用户信息，可以扩展 `public.profiles` 表：

```sql
CREATE TABLE profiles (
    id UUID REFERENCES auth.users PRIMARY KEY,
    username TEXT UNIQUE,
    avatar_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 启用 RLS (Row Level Security)
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- 创建策略：用户只能查看和修改自己的资料
CREATE POLICY "Users can view own profile"
    ON profiles FOR SELECT
    USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
    ON profiles FOR UPDATE
    USING (auth.uid() = id);
```

#### itineraries（行程表）
```sql
CREATE TABLE itineraries (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES auth.users NOT NULL,
    title TEXT NOT NULL,
    destination TEXT NOT NULL,
    start_date DATE,
    end_date DATE,
    budget DECIMAL,
    people_count INTEGER,
    preferences JSONB,  -- JSON 对象存储偏好
    ai_response JSONB,  -- 存储完整的 AI 返回结果
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 启用 RLS
ALTER TABLE itineraries ENABLE ROW LEVEL SECURITY;

-- 创建策略：用户只能访问自己的行程
CREATE POLICY "Users can view own itineraries"
    ON itineraries FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own itineraries"
    ON itineraries FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own itineraries"
    ON itineraries FOR UPDATE
    USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own itineraries"
    ON itineraries FOR DELETE
    USING (auth.uid() = user_id);

-- 创建索引
CREATE INDEX itineraries_user_id_idx ON itineraries(user_id);
CREATE INDEX itineraries_created_at_idx ON itineraries(created_at DESC);
```

#### expenses（费用记录表 - P1优先级）
```sql
CREATE TABLE expenses (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    itinerary_id UUID REFERENCES itineraries(id) ON DELETE CASCADE NOT NULL,
    user_id UUID REFERENCES auth.users NOT NULL,
    category TEXT,
    amount DECIMAL NOT NULL,
    description TEXT,
    expense_date DATE,
    voice_input BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 启用 RLS
ALTER TABLE expenses ENABLE ROW LEVEL SECURITY;

-- 创建策略
CREATE POLICY "Users can view own expenses"
    ON expenses FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own expenses"
    ON expenses FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own expenses"
    ON expenses FOR UPDATE
    USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own expenses"
    ON expenses FOR DELETE
    USING (auth.uid() = user_id);

-- 创建索引
CREATE INDEX expenses_itinerary_id_idx ON expenses(itinerary_id);
CREATE INDEX expenses_user_id_idx ON expenses(user_id);
```

### 4.2 Supabase 实时订阅（可选）
利用 Supabase 的实时功能，可以实现多设备同步：

```typescript
// 前端订阅行程变化
const subscription = supabase
  .channel('itineraries')
  .on('postgres_changes',
    { event: '*', schema: 'public', table: 'itineraries' },
    (payload) => {
      console.log('行程发生变化:', payload)
      // 更新 UI
    }
  )
  .subscribe()
```

## 五、API 设计（精简版）

### 5.1 核心 API 路由

#### 认证
- `POST /api/auth/register` - 注册
- `POST /api/auth/login` - 登录

#### 语音识别
- `POST /api/voice/recognize` - 上传音频识别

#### 行程
- `POST /api/itinerary/generate` - AI 生成行程（核心）
- `GET /api/itinerary/list` - 获取用户行程列表
- `GET /api/itinerary/<id>` - 获取行程详情
- `POST /api/itinerary/save` - 保存行程
- `DELETE /api/itinerary/<id>` - 删除行程

#### 地图（可选，前端直接调用高德 API 也可以）
- `GET /api/map/search?keyword=xxx` - 地点搜索

### 5.2 核心响应格式
```json
{
  "success": true,
  "data": {},
  "message": "操作成功"
}
```

## 六、核心技术实现要点（重点）

### 6.1 AI 提示词设计（最关键）

```python
ITINERARY_PROMPT = """你是一个专业的旅行规划助手。根据用户提供的信息生成详细的旅行计划。

用户需求：
- 目的地：{destination}
- 出行时间：{start_date} 至 {end_date}（共 {days} 天）
- 预算：{budget} 元
- 同行人数：{people_count} 人
- 偏好：{preferences}

请生成详细的旅行计划，必须严格按照以下 JSON 格式返回：

{{
  "summary": "简要总结这次旅行的亮点",
  "budget_breakdown": {{
    "transportation": 金额,
    "accommodation": 金额,
    "food": 金额,
    "attractions": 金额,
    "other": 金额
  }},
  "daily_itinerary": [
    {{
      "day": 1,
      "date": "YYYY-MM-DD",
      "theme": "第一天主题",
      "items": [
        {{
          "time": "09:00",
          "type": "attraction|restaurant|hotel|transportation",
          "title": "地点名称",
          "description": "详细描述",
          "location": "具体地址",
          "estimated_cost": 金额,
          "duration": "停留时长（如：2小时）"
        }}
      ]
    }}
  ],
  "tips": ["贴心提示1", "贴心提示2"]
}}

注意：
1. 必须返回有效的 JSON 格式
2. 每天至少包含 3-5 个行程项目
3. 合理安排时间，考虑交通时间
4. 预算分配要合理
"""
```

### 6.2 语音识别集成（复用已有代码）

直接复用 `prepare/语音识别.py` 的核心函数：
```python
from prepare.语音识别 import recognize_speech_from_file

@app.route('/api/voice/recognize', methods=['POST'])
def voice_recognize():
    if 'audio' not in request.files:
        return jsonify({'success': False, 'message': '没有上传音频文件'})

    audio_file = request.files['audio']
    # 保存临时文件
    temp_path = f"/tmp/{uuid.uuid4()}.wav"
    audio_file.save(temp_path)

    # 调用识别
    result = recognize_speech_from_file(temp_path)

    # 删除临时文件
    os.remove(temp_path)

    return jsonify(result)
```

### 6.3 配置管理（安全第一）

```python
# backend/app/config.py
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
    # Flask
    SECRET_KEY = os.getenv('SECRET_KEY', 'dev-secret-key-change-in-production')

    # Supabase
    SUPABASE_URL = os.getenv('SUPABASE_URL')
    SUPABASE_KEY = os.getenv('SUPABASE_KEY')  # anon/public key
    SUPABASE_SERVICE_KEY = os.getenv('SUPABASE_SERVICE_KEY')  # service role key (后端使用)

    # API Keys
    DEEPSEEK_API_KEY = os.getenv('DEEPSEEK_API_KEY')
    AMAP_API_KEY = os.getenv('AMAP_API_KEY')

    # CORS
    CORS_ORIGINS = os.getenv('CORS_ORIGINS', 'http://localhost:5173').split(',')

    @classmethod
    def validate(cls):
        """验证必需配置"""
        required = {
            'SUPABASE_URL': cls.SUPABASE_URL,
            'SUPABASE_KEY': cls.SUPABASE_KEY,
            'DEEPSEEK_API_KEY': cls.DEEPSEEK_API_KEY,
        }
        missing = [key for key, value in required.items() if not value]
        if missing:
            raise ValueError(f"缺少必需配置: {', '.join(missing)}")
```

**Supabase 客户端初始化**:

```python
# backend/app/supabase_client.py
from supabase import create_client, Client
from app.config import Config

# 创建 Supabase 客户端
supabase: Client = create_client(
    Config.SUPABASE_URL,
    Config.SUPABASE_SERVICE_KEY  # 后端使用 service role key
)

# 前端使用 anon key（在 TypeScript 中）
```

### 6.4 前端地图集成示例

```typescript
// 高德地图初始化
import AMapLoader from '@amap/amap-jsapi-loader';

const initMap = async () => {
  const AMap = await AMapLoader.load({
    key: "YOUR_AMAP_KEY", // 申请好的Web端开发者Key
    version: "2.0",
    plugins: ['AMap.Marker', 'AMap.Polyline']
  });

  const map = new AMap.Map('map-container', {
    zoom: 12,
    center: [116.397428, 39.90923]
  });

  return { AMap, map };
};
```

## 七、开发规范（简化）

### 7.1 Git 提交规范
```
feat: 新功能
fix: 修复
docs: 文档
style: 格式
refactor: 重构
```

示例：`feat(voice): 实现语音识别功能`

### 7.2 代码注释
- 关键函数必须有文档字符串
- 复杂逻辑添加注释
- API 接口说明清楚参数和返回值

## 八、风险控制与应对

### 8.1 时间风险
| 风险 | 概率 | 应对 |
|------|------|------|
| 前端开发超时 | 高 | UI 从简，功能优先 |
| AI 调试耗时 | 中 | 提前准备多个提示词版本 |
| Docker 部署问题 | 中 | 提前测试，准备 troubleshooting 清单 |

### 8.2 技术风险
| 风险 | 应对 |
|------|------|
| 语音识别不准 | 提供文字输入兜底 |
| AI API 限流 | 添加重试和缓存机制 |
| 地图 API 配额不足 | 减少不必要的 API 调用，添加缓存 |

### 8.3 最坏情况备选方案
- **没时间做用户系统**: 去掉登录，本地存储行程
- **地图集成困难**: 只显示文字行程，地图作为可选功能
- **语音识别有问题**: 只保留文字输入

## 九、部署方案（简化）

### 9.1 Docker Compose 示例
```yaml
version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "5000:5000"
    environment:
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - AMAP_API_KEY=${AMAP_API_KEY}
    volumes:
      - ./data:/app/data

  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
```

### 9.2 环境变量示例（.env.example）
```bash
# 请复制此文件为 .env 并填入实际的 API Keys

# Supabase 配置（必填）
SUPABASE_URL=https://xxxxxxxxxxxxx.supabase.co
SUPABASE_KEY=your-anon-public-key-here
SUPABASE_SERVICE_KEY=your-service-role-key-here

# DeepSeek API Key（必填）
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx

# 高德地图 API Key（必填）
AMAP_API_KEY=xxxxxxxxxxxxxxxx

# Flask Secret Key
SECRET_KEY=your-random-secret-key-here

# CORS 设置（可选）
CORS_ORIGINS=http://localhost:5173,http://localhost:3000
```

## 十、交付清单（必须完成）

### 10.1 代码仓库
- [x] 完整的源代码
- [x] README.md（包含运行说明）
- [x] .env.example（环境变量示例）
- [x] .gitignore（确保没有 API Key 泄露）
- [x] LICENSE

### 10.2 Docker 相关
- [ ] backend/Dockerfile
- [ ] frontend/Dockerfile
- [ ] docker-compose.yml
- [ ] 运行说明文档

### 10.3 文档
- [ ] README.md
  - [ ] 项目介绍
  - [ ] 功能列表
  - [ ] 技术栈
  - [ ] 快速开始（Docker 运行命令）
  - [ ] API Key 配置说明
  - [ ] 演示截图
- [ ] API 文档（可选，时间允许）

### 10.4 提交材料
- [ ] PDF 文档
  - [ ] GitHub 仓库地址
  - [ ] Docker 镜像地址
  - [ ] 运行命令
  - [ ] API Key（如果不是阿里云）
  - [ ] 功能演示截图

## 十一、每日检查点（Daily Checkpoint）

### Day 1 晚上检查
- ✅ Flask 后端能运行，API 可以用 Postman 测试
- ✅ 语音识别 API 正常工作
- ✅ AI 生成 API 能返回结构化 JSON
- ✅ React 前端能访问

### Day 2 晚上检查
- ✅ 前端能调用后端所有 API
- ✅ 语音输入 → AI 生成 → 结果展示 流程跑通
- ✅ 地图能显示并标记地点
- ✅ 基础 UI 完整

### Day 3 晚上检查
- ✅ 用户能注册/登录
- ✅ 行程能保存和读取
- ✅ 预算功能基本可用
- ✅ 所有核心功能演示通过

### Day 4 下午检查
- ✅ Docker 镜像构建成功
- ✅ docker-compose up 能正常运行
- ✅ README 文档完整
- ✅ 没有 API Key 泄露
- ✅ 演示截图准备好

## 十二、关键成功因素

1. **时间分配严格**: 每个任务设定时间上限，超时立即简化或跳过
2. **持续集成测试**: 每完成一个功能立即测试，不要积累问题
3. **代码复用**: 充分利用已有的语音识别代码和开源组件
4. **降级方案**: 遇到问题立即启用备选方案，不要死磕
5. **功能取舍**: P0 功能必须完成，P1 尽力，P2 果断放弃
6. **及时提交**: 每完成一个功能就 git commit，保证提交历史

## 十三、时间管理建议

### 番茄工作法（推荐）
- 25分钟专注开发
- 5分钟休息
- 每完成4个番茄钟休息15-20分钟

### 避免时间陷阱
- ❌ 过度优化代码
- ❌ 纠结 UI 细节
- ❌ 尝试新技术
- ❌ 完美主义

### 加速技巧
- ✅ 使用 AI 辅助编码（GitHub Copilot/Claude）
- ✅ 复制粘贴优秀的开源代码
- ✅ 使用现成的 UI 组件
- ✅ 前后端并行开发（Mock 数据）

---

**制定日期**: 2025-11-08
**开发周期**: 4天
**最后更新**: 2025-11-08

**预祝开发顺利！ 💪**
